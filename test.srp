require "debug"
require "allegro"
require "mfread"
require "transition_matrix"

def warning(msg)
    print "*** "; msg

midi_file_path = wxs_file_selector("Open a Standard MIDI File", 
                         "", "", ".mid", "*.mid", WXS_FILE_OPEN, 0)
print "Opening", midi_file_path
seq = allegro_smf_read(midi_file_path)
if not seq
    print "Could not read", midi_file_path
    exit()

# convert seq times to beats
seq.convert_to_beats()
# seq.convert_to_seconds()

# print the notes in seq
def show_note(note)
    print "time: "; note.time; " chan: "; note.chan; 
    print " keyno: "; note.key; " vel: "; note.loud

def track_num_notes(track):
    return len([note for note in track if isinstance(note, Alg_note)])

for track at tr in seq.tracks
    if track_num_notes(track) > 0:
        tm = TransitionMatrix(track)
        print "TRACK", tr
        print tm.mat
        tm.write("track_" + str(tr) + ".csv")
        new_tm = TransitionMatrix()
        new_tm.read("track_" + str(tr) + ".csv")
        print new_tm.mat
exit()
